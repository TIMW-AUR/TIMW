pkgname=mesa
pkgver=25.0.6
pkgrel=1
arch=(x86_64)
makedepends=(cbindgen clang cmake directx-headers elfutils expat gcc-libs glibc glslang libclc libdrm libelf libglvnd libpng libva libvdpau libx11 libxcb libxext libxml2 libxrandr libxshmfence libxxf86vm llvm llvm-libs lm_sensors meson python-mako python-packaging python-ply python-yaml rust rust-bindgen spirv-llvm-translator spirv-tools systemd-libs valgrind vulkan-icd-loader wayland wayland-protocols xcb-util-keysyms xorgproto zlib zstd)
depends=(clang expat gcc-libs glibc libclc libdrm libelf libglvnd libpng libx11 libxcb libxext libxshmfence libxxf86vm llvm-libs lm_sensors python spirv-llvm-translator spirv-tools systemd-libs vulkan-icd-loader wayland xcb-util-keysyms zlib zstd)
provides=(libva-mesa-driver mesa mesa-libgl mesa-vdpau opengl-driver opencl-driver vulkan-driver vulkan-intel vulkan-mesa-layers vulkan-nouveau vulkan-radeon vulkan-swrast vulkan-virtio)
conflicts=(libva-mesa-driver mesa mesa-libgl mesa-vdpau opengl-driver opencl-driver vulkan-driver vulkan-intel vulkan-mesa-layers vulkan-nouveau vulkan-radeon vulkan-swrast vulkan-virtio)
source=(mesa::git+https://gitlab.freedesktop.org/mesa/mesa.git#commit=d0b545b3ef3fccb8961cac35cdcfc929487a54be)

#pkgver() {
#    cd mesa
#    local _ver
#    _ver=$(<VERSION)
#    local _patchver
#    local _patchfile
#    for _patchfile in "${source[@]}"; do
#        _patchfile="${_patchfile%%::*}"
#        _patchfile="${_patchfile##*/}"
#        [[ $_patchfile = *.patch ]] || continue
#        _patchver="${_patchver}$(md5sum ${srcdir}/${_patchfile} | cut -c1-32)"
#    done
#    _patchver="$(echo -n $_patchver | md5sum | cut -c1-7)"
#    echo ${_ver/-/_}.$(git rev-list --count HEAD).$(git rev-parse --short HEAD).${_patchver}
#}

declare -A _crates=(
   paste           1.0.14
   proc-macro2     1.0.86
   quote           1.0.33
   syn             2.0.68
   unicode-ident   1.0.12
)

for _crate in "${!_crates[@]}"; do
  _ver="${_crates[$_crate]}"
  source+=(
    "$_crate-$_ver.tar.gz::https://crates.io/api/v1/crates/$_crate/$_ver/download"
  )
done

build() {
  export MESON_PACKAGE_CACHE_DIR="$srcdir"
  arch-meson mesa _build --buildtype=release -D cpp_rtti=false \
                         -D platforms=x11,wayland -D android-libbacktrace=disabled \
                         -D libunwind=disabled -D microsoft-clc=disabled -D valgrind=disabled \
                         -D gallium-drivers=radeonsi,nouveau,virgl,svga,llvmpipe,softpipe,iris,zink,d3d12 -D gallium-rusticl=true -D video-codecs=all \
                         -D vulkan-drivers=amd,intel,intel_hasvk,nouveau,swrast,virtio,microsoft-experimental -D vulkan-layers=device-select,intel-nullhw,overlay,screenshot -D vulkan-beta=true  
  meson compile -C _build
}

package() {
meson install -C _build --destdir "$pkgdir"
}
